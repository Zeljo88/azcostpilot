<section class="state-card" *ngIf="loading">
  <h2>Loading dashboard...</h2>
  <p>Reading latest cost event and history.</p>
</section>

<section class="state-card error" *ngIf="!loading && error">
  <h2>Dashboard unavailable</h2>
  <p>{{ error }}</p>
</section>

<ng-container *ngIf="!loading && !error && summary as vm">
  <section class="hero">
    <div>
      <h2>Cost Summary (Latest Billing Data)</h2>
      <p class="subtitle">Saved Azure connections: {{ connectionCount }}</p>
    </div>
    <div class="hero-badges">
      <span class="badge" [class.badge-spike]="vm.spikeFlag" [class.badge-safe]="!vm.spikeFlag">
        {{ vm.spikeFlag ? 'Spike Detected' : 'No Spike Today' }}
      </span>
      <span class="confidence" [ngClass]="getConfidenceClass(vm.confidence)">
        Confidence: {{ vm.confidence }}
        <span
          class="info-tip info-tip-inline"
          title="Indicates how clearly a single resource explains the cost change."
          aria-label="Indicates how clearly a single resource explains the cost change."
          >i</span
        >
      </span>
    </div>
  </section>

  <section class="metrics-grid">
    <article class="metric">
      <h3>Latest Cost</h3>
      <p>{{ formatCurrency(vm.todayTotal) }}</p>
    </article>
    <article class="metric">
      <h3>Previous Day</h3>
      <p>{{ formatCurrency(vm.yesterdayTotal) }}</p>
    </article>
    <article class="metric">
      <h3>Difference</h3>
      <p [class.positive]="vm.difference > 0" [class.negative]="vm.difference < 0">
        {{ formatCurrency(vm.difference) }}
      </p>
    </article>
    <article class="metric">
      <h3>
        7-Day Baseline
        <span
          class="info-tip"
          title="Your average daily cost over the last 7 days."
          aria-label="Your average daily cost over the last 7 days."
          >i</span
        >
      </h3>
      <p>{{ formatCurrency(vm.baseline) }}</p>
    </article>
    <article class="metric">
      <h3>Month-to-Date Total</h3>
      <p>{{ formatCurrency(vm.monthToDateTotal) }}</p>
    </article>
  </section>
  <p class="subtitle">Based on latest available billing data.</p>
  <p class="subtitle">Data date: {{ vm.latestDataDate | date: 'yyyy-MM-dd' }}</p>

  <section class="dev-scenarios" *ngIf="showDevScenarios">
    <h3>Development Scenarios</h3>
    <p class="dev-scenarios-subtitle">Seed synthetic data to test dashboard behavior quickly.</p>
    <div class="scenario-grid">
      <article class="scenario-card" *ngFor="let scenario of devScenarios">
        <strong>{{ scenario.label }}</strong>
        <p>{{ scenario.description }}</p>
        <button
          type="button"
          (click)="seedScenario(scenario.key)"
          [disabled]="seedingScenario !== null"
        >
          {{ seedingScenario === scenario.key ? 'Seeding...' : 'Seed Scenario' }}
        </button>
      </article>
    </div>
    <p class="dev-message success" *ngIf="seedMessage">{{ seedMessage }}</p>
    <p class="dev-message error" *ngIf="seedError">{{ seedError }}</p>
  </section>

  <section class="explanation">
    <article class="cause">
      <h3>Largest Cost Change Today</h3>
      <ng-container *ngIf="getTopCause() as cause; else noCause">
        <p class="resource-name">{{ cause.resourceName }}</p>
        <p class="resource-meta">Resource Group: {{ getResourceGroup(cause.resourceId) }}</p>
        <p class="resource-meta">Type: {{ getFriendlyResourceType(cause.resourceId) }}</p>
        <p class="increase">Increase: {{ formatCurrency(cause.increaseAmount) }}</p>
        <a
          *ngIf="buildAzurePortalUrl(cause.resourceId) as portalUrl"
          [href]="portalUrl"
          target="_blank"
          rel="noopener"
          [title]="cause.resourceId"
        >
          View in Azure
        </a>
      </ng-container>
      <ng-template #noCause>
        <p>No unusual cost changes detected today.</p>
      </ng-template>
    </article>

    <article class="suggestion">
      <h3>Suggestion</h3>
      <p>This resource contributed the most to the recent cost increase. Review it to confirm the change was expected.</p>
    </article>
  </section>

  <section class="savings" *ngIf="wasteFindings.length > 0">
    <h3>Easy Savings Found</h3>
    <p class="savings-subtitle">We found resources that may be costing money unnecessarily.</p>
    <ul>
      <li *ngFor="let finding of wasteFindings">
        <div class="finding-head">
          <strong>{{ formatFindingType(finding.findingType) }}</strong>
          <span class="saving-amount" *ngIf="finding.estimatedMonthlyCost !== null">
            {{ formatCurrency(finding.estimatedMonthlyCost) }}/mo
          </span>
        </div>
        <p class="resource-name">{{ finding.resourceName }}</p>
        <p class="resource-meta">Resource Group: {{ getResourceGroup(finding.resourceId) }}</p>
        <p class="resource-meta">Type: {{ getFriendlyResourceType(finding.resourceId) }}</p>
        <a
          *ngIf="buildAzurePortalUrl(finding.resourceId) as portalUrl"
          [href]="portalUrl"
          target="_blank"
          rel="noopener"
          [title]="finding.resourceId"
        >
          View in Azure
        </a>
      </li>
    </ul>
  </section>

  <section class="history">
    <h3>Recent Events</h3>
    <p *ngIf="history.length === 0">No unusual events in the last 7 days.</p>
    <ul *ngIf="history.length > 0">
      <li *ngFor="let event of history">
        <div>
          <strong>{{ event.date }}</strong>
          <span class="history-chip" [class.history-chip-spike]="event.spikeFlag">
            {{ event.spikeFlag ? 'Spike' : 'No Spike' }}
          </span>
        </div>
        <p>
          {{ formatCurrency(event.yesterdayTotal) }} -> {{ formatCurrency(event.todayTotal) }}
          ({{ formatCurrency(event.difference) }})
        </p>
        <p *ngIf="event.topResourceName">Top: {{ event.topResourceName }}</p>
      </li>
    </ul>
  </section>
</ng-container>
