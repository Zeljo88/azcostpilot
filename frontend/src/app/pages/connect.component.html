<section class="card">
  <h2>Connect Azure Account</h2>
  <p class="hint">Validate service principal, store encrypted secret, and run immediate 30-day backfill sync.</p>

  <form (ngSubmit)="saveConnection()">
    <label>
      Email
      <input name="email" [(ngModel)]="email" type="email" required />
    </label>

    <label>
      Password
      <input name="password" [(ngModel)]="password" type="password" required />
    </label>

    <section class="sp-section">
      <div class="sp-header">
        <h3>Azure Service Principal Credentials</h3>
        <button type="button" class="help-btn" (click)="openSpHelp()" aria-label="How to create service principal">
          ?
        </button>
      </div>
      <p class="sp-hint">Enter the tenant/app/secret values from your Azure app registration.</p>

      <label>
        Tenant ID
        <input name="tenantId" [(ngModel)]="tenantId" type="text" required />
      </label>

      <label>
        Client ID
        <input name="clientId" [(ngModel)]="clientId" type="text" required />
      </label>

      <label>
        Client Secret
        <input name="clientSecret" [(ngModel)]="clientSecret" type="password" required />
      </label>
    </section>

    <button type="submit" [disabled]="saving">
      {{ saving ? 'Saving...' : 'Connect' }}
    </button>
  </form>

  <p class="success" *ngIf="success">{{ success }}</p>
  <p class="warning" *ngIf="warning">{{ warning }}</p>
  <p class="error" *ngIf="error">{{ error }}</p>

  <div *ngIf="connections.length > 0" class="result">
    <h3>Saved Connections</h3>
    <ul>
      <li *ngFor="let connection of connections">
        {{ connection.tenantId }} / {{ connection.clientId }}
      </li>
    </ul>
  </div>

  <div *ngIf="discoveredSubscriptions.length > 0" class="result">
    <h3>Discovered Subscriptions ({{ subscriptionCount }})</h3>
    <ul>
      <li *ngFor="let subscription of discoveredSubscriptions">
        {{ subscription.displayName }} ({{ subscription.subscriptionId }})
      </li>
    </ul>
  </div>

  <a routerLink="/dashboard">Go to Dashboard</a>
</section>

<div class="modal-backdrop" *ngIf="showSpHelp" (click)="closeSpHelp()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <div class="modal-head">
      <h3>Create Service Principal (Azure CLI)</h3>
      <button type="button" class="close-btn" (click)="closeSpHelp()" aria-label="Close help">x</button>
    </div>
    <p>Run these commands in Azure CLI (replace placeholders):</p>
    <pre><code>az login
az account set --subscription "&lt;SUBSCRIPTION_ID&gt;"

az ad sp create-for-rbac --name "az-cost-pilot-sp" --skip-assignment

az role assignment create \
  --assignee "&lt;CLIENT_ID_FROM_PREVIOUS_COMMAND&gt;" \
  --role "Reader" \
  --scope "/subscriptions/&lt;SUBSCRIPTION_ID&gt;"

az role assignment create \
  --assignee "&lt;CLIENT_ID_FROM_PREVIOUS_COMMAND&gt;" \
  --role "Cost Management Reader" \
  --scope "/subscriptions/&lt;SUBSCRIPTION_ID&gt;"</code></pre>
    <p class="role-note"><strong>Roles granted:</strong> <code>Reader</code> for resource metadata and <code>Cost Management Reader</code> for cost queries.</p>
  </div>
</div>
